<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I HATE PDF - File Editor & Compressor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .drag-enter {
            border-color: #f59e0b; /* amber-500 */
        }
        /* Styles for the image editor modal */
        #editor-modal {
            background-color: rgba(0,0,0,0.7);
            transition: opacity 0.3s ease;
        }
        #image-preview-container {
            position: relative;
            overflow: hidden;
            max-width: 100%;
            max-height: 60vh;
            display: inline-block;
            user-select: none;
        }
        #image-preview-container img {
            display: block;
            max-width: 100%;
            max-height: 60vh;
        }
        #crop-box {
            position: absolute;
            box-sizing: border-box;
            border: 2px dashed #f59e0b;
            background-color: rgba(245, 158, 11, 0.2);
            cursor: move;
            user-select: none;
        }
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f59e0b;
            border: 1px solid #fff;
            border-radius: 50%;
        }
        .resize-handle.nw { top: -5px; left: -5px; cursor: nwse-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: nesw-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: nesw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: nwse-resize; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-5xl md:text-6xl font-black text-white uppercase tracking-tighter">
                I <span class="text-yellow-400">HATE</span> PDF
            </h1>
            <p class="text-gray-400 mt-2 text-lg">
                Because life's too short for massive files. Drag, drop, and shrink any document.
            </p>
        </header>

        <main id="app" class="bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-6 md:p-8 transition-all duration-300">
            <!-- All views are dynamically shown/hidden by JS -->
            <div id="uploader-view"></div>
            <div id="file-info-view" class="hidden"></div>
            <div id="processing-view" class="hidden"></div>
            <div id="result-view" class="hidden"></div>
        </main>
    </div>

    <!-- Image Editor Modal -->
    <div id="editor-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-3xl border border-gray-700">
            <h3 class="text-2xl font-bold text-white mb-4">Image Editor</h3>
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Image Preview and Cropper -->
                <div class="flex-grow flex items-center justify-center bg-gray-900 rounded-lg p-2">
                    <div id="image-preview-container">
                        <img id="image-to-edit" src="" alt="Image preview">
                        <div id="crop-box">
                            <div class="resize-handle nw"></div><div class="resize-handle ne"></div>
                            <div class="resize-handle sw"></div><div class="resize-handle se"></div>
                        </div>
                    </div>
                </div>
                <!-- Editing Controls -->
                <div class="w-full lg:w-64 flex-shrink-0">
                    <h4 class="font-semibold text-lg text-yellow-400 mb-2">Resize</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="resize-width" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2" placeholder="Width">
                        <input type="number" id="resize-height" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2" placeholder="Height">
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <select id="unit-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2">
                            <option value="px">Pixels (px)</option>
                            <option value="cm">Centimeters (cm)</option>
                            <option value="mm">Millimeters (mm)</option>
                        </select>
                        <div class="relative">
                             <input type="number" id="dpi-input" value="300" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2 pr-10">
                             <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 text-sm">DPI</span>
                        </div>
                    </div>
                    <label class="flex items-center mt-2 cursor-pointer">
                        <input type="checkbox" id="aspect-ratio-lock" class="w-4 h-4 text-yellow-400 bg-gray-700 border-gray-600 rounded focus:ring-yellow-500" checked>
                        <span class="ml-2 text-sm font-medium text-gray-300">Lock aspect ratio</span>
                    </label>

                    <div class="mt-6 flex flex-col gap-3">
                        <button id="apply-changes-btn" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-2 px-4 rounded-lg">Apply Changes</button>
                        <button id="cancel-edit-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- This canvas is used for off-screen processing -->
    <canvas id="processing-canvas" class="hidden"></canvas>

    <script>
        // --- Main App Views (Templates) ---
        const uploaderHTML = `
            <input type="file" id="file-input" class="hidden" />
            <label for="file-input" id="drop-zone" class="flex flex-col items-center justify-center w-full h-64 border-4 border-dashed border-gray-600 rounded-xl cursor-pointer hover:bg-gray-700/50 transition-colors duration-300">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                    <svg class="w-12 h-12 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                    <p class="mb-2 text-lg text-gray-400"><span class="font-semibold text-yellow-400">Click to upload</span> or drag and drop</p>
                    <p class="text-sm text-gray-500">PDF, JPG, PNG, DOCX, etc.</p>
                </div>
            </label>`;

        const fileInfoHTML = (isImage) => `
            <div class="bg-gray-700/50 rounded-xl p-4 flex items-center space-x-4">
                 <div id="file-icon" class="flex-shrink-0"></div>
                 <div class="flex-grow">
                    <p id="file-name" class="font-semibold text-white truncate"></p>
                    <p id="file-size" class="text-sm text-gray-400"></p>
                </div>
            </div>
            ${isImage ? `
            <div class="mt-4">
                <button id="edit-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg text-sm">Edit Image (Crop/Resize)</button>
            </div>` : ''}
            <div class="mt-6">
                <label for="target-quality" class="block mb-2 text-sm font-medium text-gray-300">${isImage ? 'Target Quality (%)' : 'Target Size (MB)'}</label>
                <input type="number" id="target-quality" value="${isImage ? '80' : '2'}" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-yellow-500 focus:border-yellow-500 block w-full p-2.5" placeholder="${isImage ? 'e.g., 75' : 'e.g., 5'}">
            </div>
            <div class="mt-8">
                 <button id="compress-btn" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                    Compress File
                </button>
            </div>`;
        
        // --- DOM Elements ---
        let uploaderView = document.getElementById('uploader-view');
        let fileInfoView = document.getElementById('file-info-view');
        let processingView = document.getElementById('processing-view');
        let resultView = document.getElementById('result-view');
        const editorModal = document.getElementById('editor-modal');
        const processingCanvas = document.getElementById('processing-canvas');

        // --- State Variables ---
        let originalFile = null;
        let editedFileBlob = null;
        let originalImageWidth = 0;
        let originalImageHeight = 0;

        // --- App Initialization ---
        function init() {
            // Hide all other views to ensure a clean slate
            fileInfoView.classList.add('hidden');
            processingView.classList.add('hidden');
            resultView.classList.add('hidden');
            
            // Show and populate the uploader view
            uploaderView.innerHTML = uploaderHTML;
            uploaderView.classList.remove('hidden');

            const fileInput = document.getElementById('file-input');
            const dropZone = document.getElementById('drop-zone');
            fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-enter'); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-enter'); });
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-enter'); handleFile(e.dataTransfer.files[0]); });
        }

        // --- Core Functions ---
        const handleFile = (file) => {
            if (!file) return;
            originalFile = file;
            editedFileBlob = null; 

            const isImage = file.type.startsWith('image/');
            fileInfoView.innerHTML = fileInfoHTML(isImage);
            
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-size').textContent = `Size: ${formatBytes(file.size)}`;
            document.getElementById('file-icon').innerHTML = getFileIcon(file.type);

            uploaderView.classList.add('hidden');
            fileInfoView.classList.remove('hidden');

            document.getElementById('compress-btn').addEventListener('click', startCompression);
            if (isImage) {
                document.getElementById('edit-btn').addEventListener('click', openEditor);
            }
        };

        const startCompression = () => {
            fileInfoView.classList.add('hidden');
            processingView.classList.remove('hidden');
            processingView.innerHTML = `
                <div class="mb-4"><div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-yellow-400 mx-auto"></div></div>
                <h3 class="text-xl font-semibold text-white">Compressing...</h3>
                <p class="text-gray-400 mt-2">Squeezing every last byte out of your file!</p>`;
            
            if (originalFile.type.startsWith('image/')) {
                compressImage();
            } else {
                simulateCompression();
            }
        };

        function compressImage() {
            const quality = parseInt(document.getElementById('target-quality').value, 10) / 100;
            const fileToProcess = editedFileBlob || originalFile;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const ctx = processingCanvas.getContext('2d');
                    processingCanvas.width = img.width;
                    processingCanvas.height = img.height;
                    // FIX: Fill canvas with a white background before drawing
                    // This prevents transparent areas (e.g., in PNGs) from turning black in the final JPG.
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, processingCanvas.width, processingCanvas.height);
                    ctx.drawImage(img, 0, 0);
                    processingCanvas.toBlob(blob => {
                        showResults(originalFile.size, blob);
                    }, 'image/jpeg', Math.max(0.1, Math.min(1, quality)));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(fileToProcess);
        }

        function simulateCompression() {
            setTimeout(() => {
                const originalSize = originalFile.size;
                const blob = new Blob([originalFile], { type: originalFile.type });
                showResults(originalSize, blob, true);
            }, 3000);
        }

        function showResults(originalSize, resultBlob, isSimulation = false) {
            const savings = originalSize - resultBlob.size;
            const savingsPercent = originalSize > 0 ? ((savings / originalSize) * 100).toFixed(0) : 0;
            const downloadUrl = URL.createObjectURL(resultBlob);
            
            resultView.innerHTML = `
                <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-2xl font-bold text-white">Success! We crushed it.</h3>
                <div class="flex justify-center space-x-8 mt-4 text-gray-300">
                    <div><p class="text-sm text-gray-500">Original Size</p><p class="font-semibold text-lg">${formatBytes(originalSize)}</p></div>
                    <div><p class="text-sm text-gray-500">New Size</p><p class="font-semibold text-lg text-green-400">${formatBytes(resultBlob.size)}</p></div>
                    <div><p class="text-sm text-gray-500">Savings</p><p class="font-semibold text-lg text-yellow-400">${savingsPercent}%</p></div>
                </div>
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <a href="${downloadUrl}" download="compressed-${originalFile.name}" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-4 rounded-lg text-center">Download Now</a>
                    <button id="reset-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">Compress Another</button>
                </div>
                ${isSimulation ? '<p class="text-xs text-gray-600 mt-6">* Note: Compression for this file type is simulated.</p>' : ''}`;

            processingView.classList.add('hidden');
            resultView.classList.remove('hidden');

            document.getElementById('reset-btn').addEventListener('click', () => {
                URL.revokeObjectURL(downloadUrl);
                init(); // Call the updated init function to fully reset the app
            });
        }
        
        // --- Unit Conversion Helpers ---
        function pxToUnits(pixels, unit, dpi) {
            if (unit === 'cm') return (pixels / dpi) * 2.54;
            if (unit === 'mm') return (pixels / dpi) * 25.4;
            return pixels; // px
        }

        function unitsToPx(value, unit, dpi) {
            if (unit === 'cm') return (value / 2.54) * dpi;
            if (unit === 'mm') return (value / 25.4) * dpi;
            return value; // px
        }

        // --- Image Editor Functions ---
        function openEditor() {
            const imageToEdit = document.getElementById('image-to-edit');
            const reader = new FileReader();
            reader.onload = e => {
                imageToEdit.src = e.target.result;
                imageToEdit.onload = () => {
                    originalImageWidth = imageToEdit.naturalWidth;
                    originalImageHeight = imageToEdit.naturalHeight;
                    updateDimensionInputs();
                    initCropper();
                    editorModal.classList.remove('hidden');
                }
            };
            reader.readAsDataURL(editedFileBlob || originalFile);

            document.getElementById('cancel-edit-btn').addEventListener('click', () => editorModal.classList.add('hidden'));
            document.getElementById('apply-changes-btn').addEventListener('click', applyImageChanges);
            document.getElementById('resize-width').addEventListener('input', () => handleResizeInput('width'));
            document.getElementById('resize-height').addEventListener('input', () => handleResizeInput('height'));
            document.getElementById('unit-select').addEventListener('change', updateDimensionInputs);
            document.getElementById('dpi-input').addEventListener('change', updateDimensionInputs);
        }
        
        function updateDimensionInputs() {
            const widthInput = document.getElementById('resize-width');
            const heightInput = document.getElementById('resize-height');
            const unit = document.getElementById('unit-select').value;
            const dpi = parseInt(document.getElementById('dpi-input').value) || 300;
            
            const newWidth = pxToUnits(originalImageWidth, unit, dpi);
            const newHeight = pxToUnits(originalImageHeight, unit, dpi);

            if (unit === 'px') {
                widthInput.value = Math.round(newWidth);
                heightInput.value = Math.round(newHeight);
            } else {
                widthInput.value = newWidth.toFixed(2);
                heightInput.value = newHeight.toFixed(2);
            }
        }

        function handleResizeInput(changed) {
            if (!document.getElementById('aspect-ratio-lock').checked) return;
            const widthInput = document.getElementById('resize-width');
            const heightInput = document.getElementById('resize-height');
            const unit = document.getElementById('unit-select').value;
            const dpi = parseInt(document.getElementById('dpi-input').value) || 300;
            const aspectRatio = originalImageWidth / originalImageHeight;
            
            if (changed === 'width') {
                const widthInUnits = parseFloat(widthInput.value);
                const newHeight = widthInUnits / aspectRatio;
                heightInput.value = (unit === 'px') ? Math.round(newHeight) : newHeight.toFixed(2);
            } else {
                const heightInUnits = parseFloat(heightInput.value);
                const newWidth = heightInUnits * aspectRatio;
                widthInput.value = (unit === 'px') ? Math.round(newWidth) : newWidth.toFixed(2);
            }
        }
        
        function applyImageChanges() {
            const img = document.getElementById('image-to-edit');
            const cropBox = document.getElementById('crop-box');
            const container = document.getElementById('image-preview-container');
            
            const unit = document.getElementById('unit-select').value;
            const dpi = parseInt(document.getElementById('dpi-input').value) || 300;

            const newWidthInUnits = parseFloat(document.getElementById('resize-width').value);
            const newHeightInUnits = parseFloat(document.getElementById('resize-height').value);

            const newWidthPx = Math.round(unitsToPx(newWidthInUnits, unit, dpi));
            const newHeightPx = Math.round(unitsToPx(newHeightInUnits, unit, dpi));
            
            const scaleX = img.naturalWidth / container.clientWidth;
            const scaleY = img.naturalHeight / container.clientHeight;
            
            const cropX = cropBox.offsetLeft * scaleX;
            const cropY = cropBox.offsetTop * scaleY;
            const cropWidth = cropBox.clientWidth * scaleX;
            const cropHeight = cropBox.clientHeight * scaleY;

            const ctx = processingCanvas.getContext('2d');
            processingCanvas.width = newWidthPx;
            processingCanvas.height = newHeightPx;
            // FIX: Fill canvas with a white background before drawing
            // This prevents transparent areas from turning black when the edited image is saved.
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, newWidthPx, newHeightPx);
            ctx.drawImage(img, cropX, cropY, cropWidth, cropHeight, 0, 0, newWidthPx, newHeightPx);

            processingCanvas.toBlob(blob => {
                editedFileBlob = blob;
                document.getElementById('file-size').textContent = `Edited Size: ${formatBytes(editedFileBlob.size)}`;
                editorModal.classList.add('hidden');
            }, 'image/jpeg', 0.95);
        }

        function initCropper() {
            const container = document.getElementById('image-preview-container');
            const cropBox = document.getElementById('crop-box');
            let isDragging = false, isResizing = false;
            let startX, startY, startLeft, startTop, startWidth, startHeight;
            let resizeHandle;

            cropBox.style.left = '0px'; cropBox.style.top = '0px';
            cropBox.style.width = container.clientWidth + 'px';
            cropBox.style.height = container.clientHeight + 'px';

            container.onmousedown = (e) => {
                e.preventDefault();
                startX = e.clientX;
                startY = e.clientY;
                startLeft = cropBox.offsetLeft;
                startTop = cropBox.offsetTop;
                startWidth = cropBox.clientWidth;
                startHeight = cropBox.clientHeight;
                
                if (e.target.classList.contains('resize-handle')) {
                    isResizing = true;
                    resizeHandle = e.target.className.split(' ')[1];
                } else if (e.target === cropBox) {
                    isDragging = true;
                }
            };

            document.onmousemove = (e) => {
                if (!isDragging && !isResizing) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                if (isDragging) {
                    let newLeft = startLeft + dx;
                    let newTop = startTop + dy;
                    if (newLeft < 0) newLeft = 0;
                    if (newTop < 0) newTop = 0;
                    if (newLeft + cropBox.clientWidth > container.clientWidth) newLeft = container.clientWidth - cropBox.clientWidth;
                    if (newTop + cropBox.clientHeight > container.clientHeight) newTop = container.clientHeight - cropBox.clientHeight;
                    cropBox.style.left = newLeft + 'px';
                    cropBox.style.top = newTop + 'px';
                } else if (isResizing) {
                    let newWidth = startWidth, newHeight = startHeight, newLeft = startLeft, newTop = startTop;
                    if (resizeHandle.includes('e')) newWidth = Math.max(20, startWidth + dx);
                    if (resizeHandle.includes('w')) { newWidth = Math.max(20, startWidth - dx); newLeft = startLeft + dx; }
                    if (resizeHandle.includes('s')) newHeight = Math.max(20, startHeight + dy);
                    if (resizeHandle.includes('n')) { newHeight = Math.max(20, startHeight - dy); newTop = startTop + dy; }
                    
                    if (newLeft < 0) { newWidth += newLeft; newLeft = 0; }
                    if (newTop < 0) { newHeight += newTop; newTop = 0; }
                    if (newLeft + newWidth > container.clientWidth) newWidth = container.clientWidth - newLeft;
                    if (newTop + newHeight > container.clientHeight) newHeight = container.clientHeight - newTop;

                    cropBox.style.width = newWidth + 'px';
                    cropBox.style.height = newHeight + 'px';
                    cropBox.style.left = newLeft + 'px';
                    cropBox.style.top = newTop + 'px';
                }
            };
            document.onmouseup = () => { isDragging = false; isResizing = false; };
        }

        // --- Helper Functions ---
        const formatBytes = (bytes, decimals = 2) => { if (bytes === 0) return '0 Bytes'; const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]; };
        const getFileIcon = (fileType) => { const svgClass="w-10 h-10 text-gray-400"; if (fileType.includes('pdf')) return `<svg class="${svgClass}" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM9.5 11.5c0 .83-.67 1.5-1.5 1.5H7v2H5.5v-5H8c.83 0 1.5.67 1.5 1.5v1zm-2.5.5h1v-1h-1v1zm7-1.5c0-.83.67-1.5 1.5-1.5h1.5v5H16v-2h-1.5a1.5 1.5 0 0 1-1.5-1.5v-1zm1.5.5h1v-1h-1v1zm-4.5-3.5H18v1h-3.5V7z"/></svg>`; if (fileType.includes('image')) return `<svg class="${svgClass}" fill="currentColor" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>`; if (fileType.includes('word')) return `<svg class="${svgClass}" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM12 18H7v-2h5v2zm3-4H7v-2h8v2zm0-4H7V8h8v2z"/></svg>`; return `<svg class="${svgClass}" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 9v4h-2v-4H8l4-4 4 4h-3z"/></svg>`; };

        // --- Start the app ---
        init();
    </script>
</body>
</html>



